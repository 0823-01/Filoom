<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="bookMapper">


	
	<resultMap id="bookingResultSet" type="booking">
		<id column="BOOK_NO" property="bookNo"/>
		<result column="BOOK_DATE" property="bookDate"/>
		<result column="BOOK_COST" property="bookCost"/>
		<result column="COST_PROCESS" property="costProcess"/>
		<result column="STATUS" property="status"/>
		<result column="MODIFY_DATE" property="modifyDate"/>
		<result column="USER_NO" property="userNo"/>
	</resultMap>
	
	<resultMap id = "playingResultSet" type="playing">
		<id column="PLAYING_NO" property="playingNo"/>
		<result column="PLAYTIME" property="playTime"/>
		<result column="STATUS" property="status"/>
		<result column="MOVIE_NO" property="movieNo"/>
		<result column="SCREEN_NO" property="screenNo"/>
	</resultMap>
	
	<resultMap id = "screenResultSet" type="screen">
		<id column="SCREEN_NO" property="screenNo"/>
		<result column="SCREEN_NAME" property="screenName"/>
		<result column="SCREEN_CAPACITY" property="screenCapacity"/>
		<result column="SCREEN_INFO" property="screenInfo"/>
	</resultMap>
	
	<resultMap id = "seatResultSet" type="seat">
		<id column="SEAT_NO" property="seatNo"/>
		<result column="PLATING_NO" property="playingNo"/>
		<result column="SSEAT_NO" property="sseatNo"/>		
	</resultMap>

	
	<resultMap id = "screenSeatResultSet" type="screenseat">
		<id column="SSEAT_NO" property="sseatNo"/>
		<result column="SEAT_NO" property="seatNo"/>
		<result column="SCREEN_NO" property="screenNo"/>		
	</resultMap>
	
	<resultMap id = "bookingSeatResultSet" type="bookingseat">
		<id column="BOOKING_SEAT_NO" property="bookingSeatNo"/>
		<result column="TIMELIMIT" property="timeLimit"/>	
		<result column="SSEAT_NO" property="sseatNo"/>
		<result column="PLAYING_NO" property="playingNo"/>
		<result column="BOOK_NO" property="bookNo"/>
		
		<!-- 좌석번호 -->
		<result column="SEAT_NO" property="seatNo"/> 
		
	</resultMap>
	
	<resultMap id = "selectMovieDateDetail" type="playing">
		<id column="PLAYING_NO" property="playingNo"/>
		<result column="PLAYTIME" property="playTime"/>
		<result column="STATUS" property="status"/>
		<result column="MOVIE_NO" property="movieNo"/>
		<result column="MOVIE_TITLE" property="movieTitle"/>
		<result column="SCREEN_NO" property="screenNo"/>
		<result column="RUNTIME" property="runtime"/>
		<result column="SCREEN_CAPACITY" property="screenCapacity"/>
		<result column="OCCUPIED_SEATS" property="occupiedSeats"/>
	</resultMap>
	
	<resultMap id="selectMovieSeat" type="playing">
		<id column="PLAYING_NO" property="playingNo"/>
		<result column="PLAYTIME" property="playTime"/>
		<result column="SCREEN_NO" property="screenNo"/>
		<result column="SCREEN_NAME" property="screenName"/>
		<result column="SSEAT_NO" property="sseatNo"/>
		<result column="TIMELIMIT" property="timeLimit"/>
		<result column="SEAT_NO" property="seatNo"/>
		<result column="MOVIE_TITLE" property="movieTitle"/>
		<result column="RUNTIME" property="runtime"/>

	</resultMap>
	
	<resultMap id = "deleteBookingListList" type="bookingseat">
		<id column="PLAYING_NO" property="playingNo"/>
		<result column="SEAT_NO" property="seatNo"/>
	
	</resultMap>
	
	<select id = "selectMovieDate" parameterType="_int" resultMap="selectMovieDateDetail">
		SELECT 
		    P.PLAYING_NO,
		    P.PLAYTIME,
		    P.STATUS,
		    P.MOVIE_NO,
		    S.SCREEN_NO,
		    M.RUNTIME,
		    M.MOVIE_TITLE,
		    S.SCREEN_CAPACITY,
		    (SELECT COUNT(*) 
		     FROM BOOKING_SEAT 
		     WHERE PLAYING_NO = P.PLAYING_NO 
		       AND TIMELIMIT > SYSDATE) AS OCCUPIED_SEATS
		FROM 
		    PLAYING P
		JOIN
		    MOVIE M
		ON
		    P.MOVIE_NO = M.MOVIE_NO
		JOIN
		    SCREEN S
		ON
		    P.SCREEN_NO = S.SCREEN_NO
		WHERE 
		    P.STATUS = 'Y'
		    AND P.MOVIE_NO = #{movieNo}
	</select>
	
	<select id = "selectMovieSeat" parameterType="_int" resultMap="selectMovieSeat">
		SELECT 
		    P.PLAYING_NO,
		    P.PLAYTIME,
		    P.SCREEN_NO,
		    S.SCREEN_NAME,
		    BS.SSEAT_NO,
		    BS.TIMELIMIT,
		    SS.SEAT_NO,
		    M.MOVIE_TITLE,
		    M.RUNTIME
		FROM 
		    PLAYING P
		JOIN 
		    SCREEN S
		ON 
		    P.SCREEN_NO = S.SCREEN_NO
		LEFT JOIN 
		    BOOKING_SEAT BS
		ON 
		    P.PLAYING_NO = BS.PLAYING_NO
		LEFT JOIN 
		    SCREEN_SEAT SS
		ON 
		    BS.SSEAT_NO = SS.SSEAT_NO
		JOIN 
		    MOVIE M
		ON 
		    P.MOVIE_NO = M.MOVIE_NO
		WHERE  
		    P.PLAYING_NO = #{playingNo}
	</select>
	
	
	<select id = "insertBookingSeat" parameterType="bookingseat">
		INSERT INTO BOOKING_SEAT VALUES (
            SEQ_BSNO.NEXTVAL,
            #{timeLimit},
            #{playingNo},
            (SELECT SSEAT_NO
             FROM SCREEN_SEAT
             WHERE SEAT_NO = #{seatNo}
               AND SCREEN_NO = (SELECT SCREEN_NO 
                                FROM PLAYING
                                WHERE PLAYING_NO = #{playingNo})),
            NULL
		)
	</select>
	
	<select id = "deleteBookingSeat" parameterType="bookingseat">
		DELETE FROM BOOKING_SEAT
		WHERE PLAYING_NO = #{playingNo}
		  AND SSEAT_NO = (
		      SELECT SSEAT_NO
		      FROM SCREEN_SEAT
		      WHERE SEAT_NO = #{seatNo}
		        AND SCREEN_NO = (
		            SELECT SCREEN_NO
		            FROM PLAYING
		            WHERE PLAYING_NO = #{playingNo}
		        )
		  )
	</select>
	
	
	<delete id="deleteBookingListList" parameterType="list">
	    DELETE FROM BOOKING_SEAT
	    WHERE PLAYING_NO = #{list[0].playingNo}
	      AND SSEAT_NO IN (
	          <foreach collection="list" item="seat" separator="," open="" close="">
	              (SELECT SSEAT_NO
	               FROM SCREEN_SEAT
	               WHERE SEAT_NO = #{seat.seatNo}
	                 AND SCREEN_NO = (
	                     SELECT SCREEN_NO
	                     FROM PLAYING
	                     WHERE PLAYING_NO = #{seat.playingNo}
	                 ))
	          </foreach>
	      )
	</delete>
	 
	




















	<!-- 결제 -->
	
	<select id="getBookingseatNoList" parameterType="map" resultMap="bookingSeatResultSet">

 		SELECT BOOKING_SEAT_NO
		  FROM BOOKING_SEAT BS
		  JOIN SCREEN_SEAT SS ON (BS.SSEAT_NO  = SS.SSEAT_NO)
		  JOIN PLAYING P ON (BS.PLAYING_NO = P.PLAYING_NO)
		 WHERE BS.BOOK_NO IS NULL
		   AND BS.PLAYING_NO = #{playingNo}
		   AND TIMELIMIT > SYSDATE
		   AND
		   	<foreach item="item" collection="seatNos" open="SEAT_NO IN (" separator="," close=")">
		   		#{item}
		   	</foreach>
		   
		   
	</select>
	
	<update id="updateTimeLimit" parameterType="list" >
		UPDATE BOOKING_SEAT 
		   SET TIMELIMIT = SYSDATE+INTERVAL '5' MINUTE
		 WHERE 
		 <foreach item="item" collection="list" open="BOOKING_SEAT_NO IN(" separator="," close=")">
		 	#{item.bookingSeatNo}
		 </foreach>
	</update>
	

	<insert id="setAndGetBookNo" parameterType="booking">
		INSERT INTO BOOKING (BOOK_NO,USER_NO)
		VALUES (SEQ_BNO.NEXTVAL, #{userNo})
		
		<selectKey keyProperty="bookNo" resultType="int" order="AFTER">
			SELECT SEQ_BNO.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	
	<select id="selectListBookingSeat" parameterType="list" resultMap="bookingSeatResultSet">
	   SELECT BOOKING_SEAT_NO, TIMElIMIT, SEAT_NO
	     FROM BOOKING_SEAT
	     JOIN SCREEN_SEAT USING(SSEAT_NO)
 		 <where>
		 	<foreach item="item" collection="list" open="BOOKING_SEAT_NO IN (" separator="," close=")" >
		 		#{item.bookingSeatNo}
		 	</foreach>
		 </where>
	</select>
	
</mapper>
